# vim: set expandtab shiftwidth=2 tabstop=8 textwidth=0:

#################################################################
#                                                               #
#                  container build stage                        #
#                                                               #
#################################################################

# This will create a debian image based on the following variables:
#
#  - DEBIAN_VERSION: the debian version (stretch, sid, etc...)
#  - DEBIAN_DEBS:    list of packages that needs to be installed
#  - DEBIAN_SCRIPT:  if set, this path should point to a bash script that will
#                    be run once the packages have been installed
#  - DEBIAN_USE_BACKPORTS: (true | false), defaults to false. If set, make use
#                          of the backports for stable. This will reuse
#                          DEBIAN_VERSION for enabling the backports repo.
#
# The resulting image will be pushed in the local registry, under:
#     $CI_REGISTRY_IMAGE/debian/$DEBIAN_VERSION:$CI_PIPELINE_ID
#
# It is then up to the caller to promote the image as latest or any tag
# that would be convenient

.debian@container-build:
  image: $CI_REGISTRY/bentiss/ci-templates/buildah:latest
  stage: build
  before_script:
    # log in to the registry
    - podman login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    # initial set up: take the base image, update it and install the packages
  - buildcntr=$(buildah from --quiet debian:$DEBIAN_VERSION)
  - buildmnt=$(buildah mount $buildcntr)
  - if [[ x"$DEBIAN_USE_BACKPORTS" == x"true" ]] ;
    then
      echo Enabling $DEBIAN_VERSION-backports ;
      echo "deb http://deb.debian.org/debian $DEBIAN_VERSION-backports main" >>
            $buildmnt/etc/apt/sources.list ;
    fi
  - buildah run $buildcntr cat /etc/apt/sources.list

  - buildah run $buildcntr env DEBIAN_FRONTEND=noninteractive apt-get update
  - buildah run $buildcntr env DEBIAN_FRONTEND=noninteractive apt-get -y --no-install-recommends install $DEBIAN_DEBS

    # check if there is an optional post install script and run it
  - if [[ (x"$DEBIAN_SCRIPT" != x"") && -e $DEBIAN_SCRIPT ]] ;
    then
      echo Running $DEBIAN_SCRIPT ;
      cp $DEBIAN_SCRIPT $buildmnt/script.sh ;
      buildah run $buildcntr bash /script.sh ;
      rm $buildmnt/script.sh ;
    fi

    # do not store the apt database, it s pointless
  - buildah run $buildcntr env DEBIAN_FRONTEND=noninteractive apt-get clean

    # set up the working directory
  - buildah config --workingdir /app $buildcntr
    # umount the container, not required, but, heh
  - buildah unmount $buildcntr
    # tag the current container
  - buildah commit --quiet $buildcntr $CI_REGISTRY_IMAGE/debian/$DEBIAN_VERSION:$CI_PIPELINE_ID
    # clean up the working container
  - buildah rm $buildcntr

    # push the container image to the registry
  - podman push --quiet $CI_REGISTRY_IMAGE/debian/$DEBIAN_VERSION:$CI_PIPELINE_ID

    # mark the current stage as successed, to get the result in after_script
  - touch .success


# This will create or reuse a debian image based on the following variables:
#
#  - UPSTREAM_REPO:  the upstream project on this gitlab instance where we might
#                    find the given tag (for example: 'wayland/weston')
#  - DEBIAN_VERSION: the debian version (stretch, sid, etc...)
#  - DEBIAN_DEBS:    list of packages that needs to be installed
#  - DEBIAN_SCRIPT:  if set, this path should point to a bash script that will
#                    be run once the packages have been installed
#  - DEBIAN_USE_BACKPORTS: (true | false), defaults to false. If set, make use
#                          of the backports for stable. This will reuse
#                          DEBIAN_VERSION for enabling the backports repo.
#  - DEBIAN_TAG:     tag to copy the image from the upstream registry. If the
#                    tag does not exist, create a new build and tag it
#
# The resulting image will be pushed in the local registry, under:
#     $CI_REGISTRY_IMAGE/debian/$DEBIAN_VERSION:$CI_PIPELINE_ID
# and $CI_REGISTRY_IMAGE/debian/$DEBIAN_VERSION:$DEBIAN_TAG
#

.debian@container-ifnot-exists:
  extends: .debian@container-build
  before_script:
  # log in to the registry
  - podman login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

  # check if our image is already in the current registry
  - skopeo inspect docker://$CI_REGISTRY_IMAGE/debian/$DEBIAN_VERSION:$DEBIAN_TAG > /dev/null && exit 0 || true

  # copy the original image into the current project registry namespace
  - skopeo copy docker://$CI_REGISTRY/$UPSTREAM_REPO/debian/$DEBIAN_VERSION:$DEBIAN_TAG
                docker://$CI_REGISTRY_IMAGE/debian/$DEBIAN_VERSION:$DEBIAN_TAG && exit 0 || true
  after_script:
  # if we did not build, or if there was a failure, exit
  # (the exit status does not matter here)
  - if [[ ! -e .success ]] ;
    then
      exit 0;
    fi

  - skopeo copy docker://$CI_REGISTRY_IMAGE/debian/$DEBIAN_VERSION:$CI_PIPELINE_ID
                docker://$CI_REGISTRY_IMAGE/debian/$DEBIAN_VERSION:$DEBIAN_TAG
