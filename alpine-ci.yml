# vim: set expandtab shiftwidth=2 tabstop=8 textwidth=0:
#
# THIS FILE IS GENERATED, DO NOT EDIT

variables:
  FDO_DISTRIBUTION_PACKAGES: 'wget curl'
  FDO_DISTRIBUTION_EXEC: '.hidden_dir/test.sh /test_file'


################################################################################
#
# Alpine checks
#
################################################################################


#
# A few templates to avoid writing the image and stage in each job
#
.alpine:ci@container-build:
  extends: .fdo.container-build@alpine
  image: $CI_REGISTRY_IMAGE/buildah:$BOOTSTRAP_TAG
  stage: alpine_container_build
  needs:
    - bootstrap
    - sanity check


.alpine:ci@container-ifnot-exists:
  extends: .fdo.container-ifnot-exists@alpine
  image: $CI_REGISTRY_IMAGE/buildah:$BOOTSTRAP_TAG
  stage: alpine_container_build
  needs:
    - bootstrap
    - sanity check


.alpine:ci@container-build@arm64v8:
  extends: .fdo.container-build@alpine@arm64v8
  image: $CI_REGISTRY_IMAGE/arm64v8/buildah:$BOOTSTRAP_TAG
  stage: alpine_container_build
  needs:
    - bootstrap@arm64v8
    - sanity check


.alpine:ci@container-ifnot-exists@arm64v8:
  extends: .fdo.container-ifnot-exists@alpine@arm64v8
  image: $CI_REGISTRY_IMAGE/arm64v8/buildah:$BOOTSTRAP_TAG
  stage: alpine_container_build
  needs:
    - bootstrap@arm64v8
    - sanity check

#
# generic alpine checks
#
.alpine@check:
  stage: alpine_check
  script:
      # run both curl and wget because one of those two is installed and one is
      # in the base image, but it depends on the distro which one
    - curl --insecure https://gitlab.freedesktop.org
    - wget --no-check-certificate https://gitlab.freedesktop.org
      # make sure our test script has been run
    - if [[ -e /test_file ]] ;
      then
        echo $FDO_DISTRIBUTION_EXEC properly run ;
      else
        exit 1 ;
      fi


#
# straight alpine build and test
#
alpine:latest@container-build:
  extends: .alpine:ci@container-build
  variables:
    FDO_DISTRIBUTION_TAG: $CI_PIPELINE_ID


alpine:latest@check:
  extends: .alpine@check
  image: $CI_REGISTRY_IMAGE/alpine/latest:$CI_PIPELINE_ID
  needs:
    - alpine:latest@container-build
    - sanity check


alpine:latest@container-build@arm64v8:
  extends: .alpine:ci@container-build@arm64v8
  variables:
    FDO_DISTRIBUTION_TAG: arm64v8-$CI_PIPELINE_ID


alpine:latest@check@arm64v8:
  extends: .alpine@check
  image: $CI_REGISTRY_IMAGE/alpine/latest:arm64v8-$CI_PIPELINE_ID
  tags:
    - aarch64
  needs:
    - alpine:latest@container-build@arm64v8
    - sanity check


#
# make sure we do rebuild the image if the tag does not exist and check
#
alpine-forced:latest@container-ifnot-exists:
  extends: .alpine:ci@container-ifnot-exists
  variables:
    FDO_UPSTREAM_REPO: $CI_PROJECT_PATH
    FDO_DISTRIBUTION_TAG: $CI_PIPELINE_IID


alpine-forced-ifnot-exists:latest@check:
  extends: .alpine@check
  image: $CI_REGISTRY_IMAGE/alpine/latest:$CI_PIPELINE_IID
  needs:
    - alpine-forced:latest@container-ifnot-exists
    - sanity check


#
# make sure we do not rebuild the image if the tag exists (during the check)
#
alpine:latest@container-ifnot-exists:
  extends: .alpine:ci@container-ifnot-exists
  stage: alpine_check
  variables:
    FDO_UPSTREAM_REPO: $CI_PROJECT_PATH
    FDO_DISTRIBUTION_TAG: $CI_PIPELINE_IID
    FDO_DISTRIBUTION_PACKAGES: 'this-package-should-not-exist'
  needs:
    - alpine-forced:latest@container-ifnot-exists
    - sanity check


#
# make sure we do not rebuild the image if the tag exists in the upstream
# repository (during the check)
# special case where FDO_REPO_SUFFIX == ci_templates_test_upstream
#
alpine:latest-upstream@container-ifnot-exists:
  extends: .alpine:ci@container-ifnot-exists
  stage: alpine_check
  variables:
    FDO_UPSTREAM_REPO: $CI_PROJECT_PATH
    FDO_REPO_SUFFIX: ci_templates_test_upstream
    FDO_DISTRIBUTION_TAG: $CI_PIPELINE_IID
    FDO_DISTRIBUTION_PACKAGES: 'this-package-should-not-exist'
  needs:
    - alpine-forced:latest@container-ifnot-exists
    - sanity check
