# vim: set expandtab shiftwidth=2 tabstop=8 textwidth=0:

variables:
  CENTOS_RPMS: 'wget'
  CENTOS_EXEC: '/bin/bash test/script.sh'


################################################################################
#
# Fedora checks
#
################################################################################


#
# A few templates to avoid writing the image and stage in each job
#
.centos:ci@container-build:
  extends: .centos@container-build
  image: $CI_REGISTRY_IMAGE/buildah:$BOOTSTRAP_TAG
  stage: centos_container_build


.centos:ci@container-ifnot-exists:
  extends: .centos@container-ifnot-exists
  image: $CI_REGISTRY_IMAGE/buildah:$BOOTSTRAP_TAG
  stage: centos_container_build


#
# generic centos checks
#
.centos@check:
  stage: centos_check
  script:
      # make sure wget has been installed
    - wget https://gitlab.freedesktop.org
      # make sure our test script has been run
    - if [[ -e /test_file ]] ;
      then
        echo $CENTOS_SCRIPT properly run ;
      else
        exit 1 ;
      fi


#
# straight centos build and test
#
# Centos 6 segfaults during yum upgrade for unknown reasons
#
# centos:6@container-build:
#   extends: .centos:ci@container-build
#   variables:
#     CENTOS_VERSION: 6
#     CENTOS_TAG: $CI_PIPELINE_ID
#
#
# centos:6@check:
#   extends: .centos@check
#   image: $CI_REGISTRY_IMAGE/centos/6:$CI_PIPELINE_ID


centos:7@container-build:
  extends: .centos:ci@container-build
  variables:
    CENTOS_VERSION: 7
    CENTOS_TAG: $CI_PIPELINE_ID


centos:7@check:
  extends: .centos@check
  image: $CI_REGISTRY_IMAGE/centos/7:$CI_PIPELINE_ID


centos:8@container-build:
  extends: .centos:ci@container-build
  variables:
    CENTOS_VERSION: 8
    CENTOS_TAG: $CI_PIPELINE_ID


centos:8@check:
  extends: .centos@check
  image: $CI_REGISTRY_IMAGE/centos/8:$CI_PIPELINE_ID


#
# make sure we do rebuild the image if the tag does not exist and check
#
centos-forced:8@container-ifnot-exists:
  extends: .centos:ci@container-ifnot-exists
  variables:
    UPSTREAM_REPO: wayland/ci-templates
    CENTOS_VERSION: 8
    CENTOS_TAG: $CI_PIPELINE_IID


centos-forced-ifnot-exists:8@check:
  extends: .centos@check
  image: $CI_REGISTRY_IMAGE/centos/8:$CI_PIPELINE_IID


#
# make sure we do not rebuild the image if the tag exists (during the check)
#
centos:8@container-ifnot-exists:
  extends: .centos:ci@container-ifnot-exists
  stage: centos_check
  variables:
    UPSTREAM_REPO: wayland/ci-templates
    CENTOS_VERSION: 8
    CENTOS_TAG: $CI_PIPELINE_IID
    CENTOS_RPMS: 'this-package-should-not-exist'


#
# FIXME
# make sure we do not rebuild the image if the tag exists in the upstream
# repository (during the check)
#
.centos:7-upstream@container-ifnot-exists:
  extends: .centos:ci@container-ifnot-exists
  stage: centos_check
  variables:
    UPSTREAM_REPO: libinput/libinput
    CENTOS_VERSION: 7
    CENTOS_TAG: latest
    CENTOS_RPMS: 'this-package-should-not-exist'
