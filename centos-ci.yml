# vim: set expandtab shiftwidth=2 tabstop=8 textwidth=0:

variables:
  CENTOS_RPMS: 'wget'
  CENTOS_EXEC: './test/script.sh'


################################################################################
#
# Centos checks
#
################################################################################


#
# A few templates to avoid writing the image and stage in each job
#
.centos:ci@container-build:
  extends: .centos@container-build
  image: $CI_REGISTRY_IMAGE/buildah:$BOOTSTRAP_TAG
  stage: centos_container_build
  needs:
    - bootstrap
    - sanity check


.centos:ci@container-ifnot-exists:
  extends: .centos@container-ifnot-exists
  image: $CI_REGISTRY_IMAGE/buildah:$BOOTSTRAP_TAG
  stage: centos_container_build
  needs:
    - bootstrap
    - sanity check


#
# generic centos checks
#
.centos@check:
  stage: centos_check
  script:
      # make sure wget has been installed
    - wget https://gitlab.freedesktop.org
      # make sure our test script has been run
    - if [[ -e /test_file ]] ;
      then
        echo $CENTOS_EXEC properly run ;
      else
        exit 1 ;
      fi


#
# straight centos build and test
#
centos:7@container-build:
  extends: .centos:ci@container-build
  variables:
    CENTOS_VERSION: '7'
    CENTOS_TAG: $CI_PIPELINE_ID


centos:7@check:
  extends: .centos@check
  image: $CI_REGISTRY_IMAGE/centos/7:$CI_PIPELINE_ID
  needs:
    - centos:7@container-build
    - sanity check


#
# make sure we do rebuild the image if the tag does not exist and check
#
centos-forced:7@container-ifnot-exists:
  extends: .centos:ci@container-ifnot-exists
  variables:
    UPSTREAM_REPO: $CI_PROJECT_PATH
    CENTOS_VERSION: '7'
    CENTOS_TAG: $CI_PIPELINE_IID


centos-forced-ifnot-exists:7@check:
  extends: .centos@check
  image: $CI_REGISTRY_IMAGE/centos/7:$CI_PIPELINE_IID
  needs:
    - centos-forced:7@container-ifnot-exists
    - sanity check


#
# make sure we do not rebuild the image if the tag exists (during the check)
#
centos:7@container-ifnot-exists:
  extends: .centos:ci@container-ifnot-exists
  stage: centos_check
  variables:
    UPSTREAM_REPO: $CI_PROJECT_PATH
    CENTOS_VERSION: '7'
    CENTOS_TAG: $CI_PIPELINE_IID
    CENTOS_RPMS: 'this-package-should-not-exist'
  needs:
    - centos-forced:7@container-ifnot-exists
    - sanity check


#
# make sure we do not rebuild the image if the tag exists in the upstream
# repository (during the check)
# special case where REPO_SUFFIX == ci_templates_test_upstream
#
centos:7-upstream@container-ifnot-exists:
  extends: .centos:ci@container-ifnot-exists
  stage: centos_check
  variables:
    UPSTREAM_REPO: $CI_PROJECT_PATH
    REPO_SUFFIX: ci_templates_test_upstream
    CENTOS_VERSION: '7'
    CENTOS_TAG: $CI_PIPELINE_IID
    CENTOS_RPMS: 'this-package-should-not-exist'
  needs:
    - centos-forced:7@container-ifnot-exists
    - sanity check

#
# Try our centos scripts with other versions and check
#

centos:8@container-build:
  extends: .centos:ci@container-build
  variables:
    CENTOS_VERSION: '8'
    CENTOS_TAG: $CI_PIPELINE_ID

centos:8@check:
  extends: .centos@check
  image: $CI_REGISTRY_IMAGE/centos/8:$CI_PIPELINE_ID
  needs:
    - centos:8@container-build
    - sanity check
